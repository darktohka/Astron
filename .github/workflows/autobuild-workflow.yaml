name: Autobuild for Windows

on: [push, workflow_dispatch, repository_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Install OpenSSL
        shell: powershell
        run: |
          choco install -y openssl.light
      - name: Download Zstandard
        uses: suisei-cn/actions-download-file@v1
        with:
          url: "https://github.com/facebook/zstd/archive/refs/heads/dev.tar.gz"
          target: ./
      - name: Setup Zstandard
        working-directory: ./zstd-dev/build/cmake
        shell: bash
        run: |
          cmake -G"Visual Studio 17 2022" -A x64 -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/libraries/zstd \
            -DZSTD_LEGACY_SUPPORT=OFF -DZSTD_BUILD_PROGRAMS=OFF -DZSTD_BUILD_CONTRIB=OFF -DZSTD_BUILD_TESTS=OFF \
            -DZSTD_BUILD_STATIC=ON -DZSTD_BUILD_SHARED=OFF
      - name: Compile Zstandard
        working-directory: ./zstd-dev/build/cmake
        shell: bash
        run: |
          cmake --build . --config Release
      - name: Checkout code
        uses: actions/checkout@v2
      - uses: suisei-cn/actions-download-file@v1
        name: Download mongo-c-driver
        with:
          url: "https://github.com/mongodb/mongo-c-driver/archive/refs/heads/master.tar.gz"
          target: ./
      - name: Extract mongo-c-driver
        shell: bash
        run: |
          tar -xzf master.tar.gz
      - name: Setup mongo-c-driver
        working-directory: ./mongo-c-driver-master
        shell: bash
        run: |
          cmake -G"Visual Studio 17 2022" -A x64 -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/libraries/mongoc \
            -DENABLE_STATIC=ON -DENABLE_ZLIB=OFF -DENABLE_ZSTD=ON -DENABLE_SNAPPY=OFF -DENABLE_SASL=OFF \
            -DENABLE_SSL=OPENSSL -DENABLE_MONGODB_AWS_AUTH=OFF -DENABLE_EXTRA_ALIGNMENT=OFF -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF .
      - name: Compile mongo-c-driver
        working-directory: ./mongo-c-driver-master
        shell: bash
        run: |
          cmake --build . --config Release
